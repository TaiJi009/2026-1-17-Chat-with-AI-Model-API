# 部署方案调整说明

## 变更概述

部署方案已从 **"腾讯云CVM + Docker"** 调整为 **"纯Docker部署"**。

## 变更内容

### 1. 架构调整

**之前:**
```
前端 → 腾讯云CVM服务器 → Docker容器 → PostgreSQL
```

**现在:**
```
前端 → Docker容器（本地/托管平台）→ PostgreSQL（Docker容器）
```

### 2. 部署方式

#### 方式1: 本地Docker部署（开发环境）
- 使用Docker Desktop（Windows/Mac）或Docker Engine（Linux）
- 通过Docker Compose一键启动所有服务
- 适合本地开发和测试

#### 方式2: Docker托管平台（生产环境）
- Railway、Render、Fly.io等平台
- 自动提供HTTPS和域名
- 无需管理服务器

#### 方式3: 自定义服务器（可选）
- 在VPS上运行Docker
- 可配置Nginx反向代理
- 可配置自定义域名和SSL

### 3. 优势

1. **简化部署**: 无需配置服务器，一条命令启动
2. **降低成本**: Docker托管平台通常比CVM便宜
3. **自动HTTPS**: 平台自动提供SSL证书
4. **易于扩展**: 容器化便于横向扩展
5. **环境一致**: 开发和生产环境一致

### 4. 更新的文件

#### 配置文件
- ✅ `backend/docker/docker-compose.yml` - 添加完整环境变量和健康检查
- ✅ `backend/docker/Dockerfile` - 优化为多阶段构建，添加安全配置

#### 文档文件
- ✅ `docs/付费功能与账号系统.md` - 更新部署指南
- ✅ `backend/README.md` - 更新Docker部署说明
- ✅ `backend/docker/README.md` - 新增详细Docker指南
- ✅ `docs/Docker部署快速指南.md` - 新增快速参考

#### 计划文件
- ✅ 更新计划文件中的部署方案

### 5. 环境变量配置

所有必需的环境变量已在 `docker-compose.yml` 中配置：

```yaml
environment:
  # 数据库
  DATABASE_URL: ...
  DB_HOST: postgres
  DB_PORT: 5432
  
  # JWT
  JWT_SECRET: ${JWT_SECRET}
  JWT_EXPIRES_IN: ${JWT_EXPIRES_IN:-7d}
  
  # 微信支付
  WECHAT_APP_ID: ${WECHAT_APP_ID}
  WECHAT_MCH_ID: ${WECHAT_MCH_ID}
  WECHAT_API_KEY: ${WECHAT_API_KEY}
  WECHAT_NOTIFY_URL: ${WECHAT_NOTIFY_URL}
  
  # 腾讯云短信
  TENCENT_SMS_SECRET_ID: ${TENCENT_SMS_SECRET_ID}
  TENCENT_SMS_SECRET_KEY: ${TENCENT_SMS_SECRET_KEY}
  TENCENT_SMS_APP_ID: ${TENCENT_SMS_APP_ID}
  TENCENT_SMS_SIGN_NAME: ${TENCENT_SMS_SIGN_NAME}
  TENCENT_SMS_TEMPLATE_ID: ${TENCENT_SMS_TEMPLATE_ID}
  
  # 服务器
  PORT: 3000
  NODE_ENV: ${NODE_ENV:-production}
  CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
```

### 6. 快速开始

```bash
# 1. 配置环境变量
cd backend
cp .env.example .env
# 编辑.env文件

# 2. 启动服务
cd docker
docker-compose up -d

# 3. 运行数据库迁移
docker-compose exec backend npm run migrate

# 4. 查看日志
docker-compose logs -f
```

### 7. 迁移指南

如果之前使用CVM部署，迁移步骤：

1. **备份数据**
```bash
# 在CVM上备份数据库
pg_dump -U user chat_app > backup.sql
```

2. **在新环境恢复**
```bash
# 在Docker环境中恢复
docker-compose exec -T postgres psql -U user chat_app < backup.sql
```

3. **更新配置**
- 更新环境变量
- 更新微信支付回调URL（如果域名变化）
- 更新前端API地址

### 8. 注意事项

1. **数据持久化**: 使用Docker volumes确保数据不丢失
2. **备份策略**: 定期备份PostgreSQL数据卷
3. **资源限制**: 生产环境建议配置资源限制
4. **监控日志**: 配置日志管理和监控
5. **安全配置**: 使用强密码和密钥

## 相关文档

- [Docker部署快速指南](./Docker部署快速指南.md)
- [完整部署文档](./付费功能与账号系统.md#部署指南)
- [Docker详细配置](../backend/docker/README.md)
