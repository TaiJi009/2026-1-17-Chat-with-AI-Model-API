# 数据库迁移

## 首次部署迁移

首次部署后，必须运行数据库迁移以创建表结构：

```bash
railway run npm run migrate
```

## 后续迁移

当您修改数据库结构时：

1. 创建新的迁移文件（如 `002_add_new_table.sql`）
2. 更新 `migrations/run-migrations.ts` 以支持多个迁移文件
3. 推送到 GitHub，Railway 会自动重新部署
4. 部署完成后，使用 Railway CLI 运行迁移：
   ```bash
   railway run npm run migrate
   ```

## 迁移方法

### 方法 1: 使用 Railway CLI（推荐）

```bash
# 安装 Railway CLI
npm i -g @railway/cli

# 登录
railway login

# 链接项目
railway link

# 运行迁移
railway run npm run migrate
```

若在本地运行 `railway run npm run migrate` 时出现无法解析 `postgres.railway.internal`，说明 `DATABASE_URL` 为内网地址，请改用下方「方法 2：使用 Railway 控制台」在服务 Shell 内执行迁移。

### 方法 2: 使用 Railway 控制台

1. 在服务页面点击 **"Deployments"** 标签
2. 找到最新的部署，点击 **"View Logs"**
3. 在部署日志中，点击 **"Open Shell"** 或 **"Terminal"**
4. 运行迁移命令：`npm run migrate`

### 方法 3: 自动迁移（开发环境）

如果需要在每次部署时自动运行迁移（仅用于开发环境）：

1. 在环境变量中添加 `AUTO_MIGRATE=true`
2. 修改 `backend/src/app.ts` 在启动时检查此变量并运行迁移

⚠️ **注意**: 生产环境建议手动运行迁移，以便更好地控制迁移时机。

## 迁移策略

### 开发环境

- 可以使用自动迁移（设置 `AUTO_MIGRATE=true`）
- 可以频繁运行迁移进行测试

### 生产环境

建议手动运行迁移，以便：

- 在迁移前备份数据库
- 在低峰期运行迁移
- 验证迁移结果
- 控制迁移时机

## 迁移最佳实践

1. **备份数据库**：在生产环境运行迁移前，先备份数据库
2. **测试迁移**：在开发环境充分测试迁移脚本
3. **版本控制**：将迁移文件纳入版本控制
4. **回滚计划**：准备回滚方案，以防迁移失败
5. **监控**：迁移后监控应用状态，确保一切正常

## 相关文档

- [Railway CLI 使用](05-Railway%20CLI使用.md) - 了解 CLI 工具的更多用法
- [故障排查](09-故障排查.md) - 如果迁移失败，查看故障排查章节
