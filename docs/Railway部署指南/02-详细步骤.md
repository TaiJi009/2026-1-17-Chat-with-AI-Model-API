# 详细步骤

本指南提供 Railway 部署的详细步骤说明。

## 步骤 1: 创建 Railway 账号

1. 访问 [railway.app](https://railway.app)
2. 点击 **"Login"** 或 **"Sign Up"**
3. 选择使用 GitHub 账号登录（推荐）

## 步骤 2: 创建新项目

1. 登录后，点击 **"New Project"**
2. 选择 **"Deploy from GitHub repo"**
3. 如果首次使用，需要授权 Railway 访问 GitHub：
   - 点击 **"Configure GitHub App"**
   - 选择要授权的仓库（可以选择所有仓库或特定仓库）
   - 点击 **"Install"**

## 步骤 3: 选择仓库

1. 在仓库列表中选择您的项目仓库
2. Railway 会自动开始检测项目结构

## 步骤 4: 添加 PostgreSQL 数据库

1. 在项目页面点击 **"+ New"**
2. 选择 **"Database"**
3. 选择 **"Add PostgreSQL"**
4. Railway 会自动创建数据库实例
5. 数据库创建后，Railway 会自动创建一个 `DATABASE_URL` 环境变量，其他服务可以使用它

## 步骤 5: 配置后端服务

### 5.1 添加 Web Service

1. 在项目页面点击 **"+ New"**
2. 选择 **"GitHub Repo"**（选择同一个仓库）
3. Railway 会提示选择服务类型，选择 **"Web Service"**

### 5.2 设置 Root Directory

1. 在服务的 **Settings → Deploy** 页面
2. 找到 **"Root Directory"** 设置
3. 输入 `backend`
4. Railway 会自动检测为 Node.js 项目

### 5.3 配置构建和启动命令（可选）

Railway 会自动检测 Node.js 项目，但您可以手动配置：

- **Build Command**: `npm install && npm run build`
- **Start Command**: `npm start`

这些配置也可以在 `railway.json` 文件中设置（如果已创建）。

## 步骤 6: 配置环境变量

在服务的 **Settings → Variables** 页面添加环境变量：

### 必需的环境变量

```env
# 数据库（Railway PostgreSQL 自动提供，使用引用）
DATABASE_URL=${{PostgreSQL.DATABASE_URL}}

# JWT 配置
JWT_SECRET=your-secret-key-change-this
JWT_EXPIRES_IN=7d

# 服务器配置
PORT=${{PORT}}
NODE_ENV=production
CORS_ORIGIN=https://your-frontend-domain.com
```

### 微信支付配置（如果使用）

```env
WECHAT_APP_ID=your-app-id
WECHAT_MCH_ID=your-merchant-id
WECHAT_API_KEY=your-api-key
WECHAT_NOTIFY_URL=https://your-railway-domain.railway.app/api/payment/wechat/callback
WECHAT_SANDBOX=false
```

### 腾讯云短信配置（如果使用）

```env
TENCENT_SMS_SECRET_ID=your-secret-id
TENCENT_SMS_SECRET_KEY=your-secret-key
TENCENT_SMS_APP_ID=your-sms-app-id
TENCENT_SMS_SIGN_NAME=your-sign-name
TENCENT_SMS_TEMPLATE_ID=your-template-id
```

### 环境变量引用

Railway 支持使用 `${{ServiceName.VariableName}}` 引用其他服务的环境变量：

- `${{PostgreSQL.DATABASE_URL}}` - 引用 PostgreSQL 数据库连接字符串
- `${{PORT}}` - Railway 自动提供的端口号

详细的环境变量配置说明请参考：[环境变量配置](03-环境变量配置.md)

## 步骤 7: 运行数据库迁移

### 方法 1: 使用 Railway CLI

```bash
# 安装 Railway CLI
npm i -g @railway/cli

# 登录
railway login

# 链接项目
railway link

# 运行迁移
railway run npm run migrate
```

### 方法 2: 使用 Railway 控制台

1. 在服务页面点击 **"Deployments"** 标签
2. 找到最新的部署，点击 **"View Logs"**
3. 在部署日志中，点击 **"Open Shell"** 或 **"Terminal"**
4. 运行迁移命令：`npm run migrate`

### 方法 3: 自动迁移（开发环境）

如果需要在每次部署时自动运行迁移（仅用于开发环境）：

1. 在环境变量中添加 `AUTO_MIGRATE=true`
2. 修改 `backend/src/app.ts` 在启动时检查此变量并运行迁移

⚠️ **注意**: 生产环境建议手动运行迁移，以便更好地控制迁移时机。

详细的迁移说明请参考：[数据库迁移](04-数据库迁移.md)

## 步骤 8: 验证部署

1. 在服务页面查看部署状态
2. 等待构建完成（通常需要 1-3 分钟）
3. Railway 会提供一个默认域名，格式如：`your-service.railway.app`
4. 访问 `https://your-service.railway.app/health` 验证服务是否正常运行
5. 应该返回 JSON 响应：`{"success":true,"message":"服务运行正常",...}`

## 下一步

- 查看 [环境变量配置](03-环境变量配置.md) 了解完整的环境变量列表
- 查看 [Railway CLI 使用](05-Railway%20CLI使用.md) 学习命令行工具
- 查看 [GitHub 集成与自动部署](06-GitHub集成与自动部署.md) 配置自动部署
