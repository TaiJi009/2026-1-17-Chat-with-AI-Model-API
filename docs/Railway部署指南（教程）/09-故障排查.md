# 故障排查

本文档提供 Railway 部署过程中常见问题的排查和解决方案。

## 常见问题

### 1. 构建失败

**问题**: 部署时构建失败

**排查步骤**:
1. 查看构建日志，找到错误信息
2. 检查 `package.json` 中的依赖是否正确
3. 确认 Node.js 版本兼容性
4. 检查 `railway.json` 配置（如果使用）

**解决方案**:
- 确保所有依赖都在 `package.json` 中
- 检查 TypeScript 编译错误
- 确认构建命令正确
- 检查是否有 Dockerfile 干扰（应该使用 Nixpacks）

**常见错误**:
- `npm: command not found` - 可能是使用了 Dockerfile 而不是 Nixpacks
- `Module not found` - 检查依赖是否正确安装
- `TypeScript compilation error` - 检查代码语法错误

### 2. 数据库连接失败

**问题**: 应用无法连接到数据库

**排查步骤**:
1. 检查 `DATABASE_URL` 环境变量是否正确设置
2. 确认使用了 `${{PostgreSQL.DATABASE_URL}}` 引用
3. 查看应用日志中的错误信息

**解决方案**:
- 在 Variables 页面检查 `DATABASE_URL` 是否正确
- 确认 PostgreSQL 服务已启动
- 检查数据库连接字符串格式
- 确认数据库服务与后端服务在同一项目中

### 3. 端口错误

**问题**: 服务无法启动，端口相关错误

**排查步骤**:
1. 确认代码使用 `process.env.PORT` 而不是硬编码端口
2. 检查环境变量中是否设置了 `PORT`

**解决方案**:
- 代码中应使用 `process.env.PORT || 3000`
- Railway 会自动提供 `PORT` 环境变量，无需手动设置
- 不要硬编码端口号

### 4. CORS 错误

**问题**: 前端无法访问后端 API

**排查步骤**:
1. 检查 `CORS_ORIGIN` 环境变量是否正确设置
2. 确认前端域名已添加到 `CORS_ORIGIN`

**解决方案**:
- 更新 `CORS_ORIGIN` 为正确的前端域名
- 多个域名用逗号分隔：`https://domain1.com,https://domain2.com`
- 确保包含协议（`https://` 或 `http://`）

### 5. 环境变量未生效

**问题**: 修改环境变量后，应用仍使用旧值

**解决方案**:
- 环境变量修改后，需要重新部署服务
- 可以在 **Deployments** 页面手动触发部署
- 或推送一个空提交到 GitHub 触发自动部署

### 6. 服务无法访问

**问题**: 部署成功后，服务无法通过域名访问

**排查步骤**:
1. 检查服务状态是否为 "Active"
2. 查看服务日志，确认应用已正常启动
3. 检查健康检查端点是否正常

**解决方案**:
- 确认服务状态为 "Active"
- 查看日志确认应用已启动
- 访问 `/health` 端点验证服务状态
- 检查防火墙或网络配置

### 7. 数据库迁移失败

**问题**: 运行数据库迁移时出错

**排查步骤**:
1. 查看迁移日志
2. 检查迁移文件语法
3. 确认数据库连接正常

**解决方案**:
- 检查 SQL 语法错误
- 确认迁移文件路径正确
- 检查数据库权限
- 在开发环境先测试迁移

## 获取帮助

如果遇到其他问题：

1. **查看 Railway 官方文档**：https://docs.railway.app
2. **在 Railway Discord 社区寻求帮助**
3. **查看项目 GitHub Issues**
4. **查看 Railway 状态页面**：确认服务是否正常

## 调试技巧

### 1. 查看详细日志

使用 Railway CLI 查看详细日志：

```bash
railway logs -f
```

### 2. 运行本地测试

在本地环境测试应用：

```bash
cd backend
npm install
npm run build
npm start
```

### 3. 检查环境变量

使用 CLI 查看环境变量：

```bash
railway variables
```

### 4. 测试数据库连接

使用 CLI 测试数据库连接：

```bash
railway run node -e "console.log(process.env.DATABASE_URL)"
```

## 相关文档

- [环境变量配置](03-环境变量配置.md) - 检查环境变量配置
- [数据库迁移](04-数据库迁移.md) - 数据库迁移相关问题
- [监控和日志](08-监控和日志.md) - 查看日志进行排查
- [最佳实践](10-最佳实践.md) - 预防问题的最佳实践
