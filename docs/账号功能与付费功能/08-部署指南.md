# 08-部署指南

## Docker环境准备

### 1. 本地开发环境

**Windows/Mac:**
- 安装 [Docker Desktop](https://www.docker.com/products/docker-desktop/)
- Docker Desktop 已包含 Docker Compose

**Linux:**
```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 2. Docker托管平台（可选）

如果使用Docker托管平台，无需本地安装：
- **Render**: 支持Docker部署，自动提供HTTPS
- **Fly.io**: 支持Docker部署，全球CDN

### 3. Docker Compose配置

```yaml
# docker/docker-compose.yml
version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: chat_app_postgres
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    restart: unless-stopped

  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: chat_app_backend
    environment:
      DATABASE_URL: postgresql://${DB_USER}:${DB_PASSWORD}@postgres:5432/${DB_NAME}
      JWT_SECRET: ${JWT_SECRET}
      WECHAT_APP_ID: ${WECHAT_APP_ID}
      WECHAT_MCH_ID: ${WECHAT_MCH_ID}
      WECHAT_API_KEY: ${WECHAT_API_KEY}
      WECHAT_NOTIFY_URL: ${WECHAT_NOTIFY_URL}
      TENCENT_SMS_SECRET_ID: ${TENCENT_SMS_SECRET_ID}
      TENCENT_SMS_SECRET_KEY: ${TENCENT_SMS_SECRET_KEY}
      TENCENT_SMS_APP_ID: ${TENCENT_SMS_APP_ID}
      TENCENT_SMS_SIGN_NAME: ${TENCENT_SMS_SIGN_NAME}
      TENCENT_SMS_TEMPLATE_ID: ${TENCENT_SMS_TEMPLATE_ID}
      PORT: 3000
      NODE_ENV: production
      CORS_ORIGIN: ${CORS_ORIGIN}
    ports:
      - "3000:3000"
    depends_on:
      - postgres
    restart: unless-stopped

volumes:
  postgres_data:
```

### 4. Nginx反向代理配置

```nginx
# /etc/nginx/sites-available/chat-app-api
server {
    listen 80;
    server_name api.yourdomain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## 部署步骤

1. **克隆代码到服务器**
```bash
git clone https://github.com/your-repo/chat-app.git
cd chat-app/backend
```

2. **配置环境变量**
```bash
cp .env.example .env
# 编辑.env文件，填入所有配置
```

3. **运行数据库迁移**
```bash
docker-compose exec backend npm run migrate
```

4. **启动服务**
```bash
docker-compose up -d
```

5. **查看日志**
```bash
docker-compose logs -f
```

---

**相关文档**:
- [07-后端实现](./07-后端实现.md)
- [09-安全考虑](./09-安全考虑.md)
- [10-开发步骤](./10-开发步骤.md)
- [返回目录](./00-目录.md)
