# 06-前端实现

## 文件修改清单

### 需要修改的现有文件

1. **src/types/index.ts**
   - 添加用户、订单、验证码相关类型定义
   - 扩展AppState添加用户状态

2. **src/contexts/AppContext.tsx**
   - 修改默认主题为`dark`
   - 添加用户状态管理
   - 添加Pro状态检查

3. **src/components/ThemeToggle.tsx**
   - 添加Pro权限检查
   - 非Pro用户显示支付弹窗

4. **src/App.tsx**
   - 集成AuthProvider
   - 添加登录状态检查

### 需要新建的文件

1. **src/contexts/AuthContext.tsx**
   - 用户认证状态管理
   - Token管理
   - 登录/登出函数

2. **src/components/LoginModal.tsx**
   - 手机号输入
   - 验证码发送和验证
   - 登录/注册UI

3. **src/components/PaymentModal.tsx**
   - 支付二维码显示
   - 支付状态轮询
   - 支付成功提示

4. **src/services/authService.ts**
   - 认证相关API调用

5. **src/services/paymentService.ts**
   - 支付相关API调用

6. **src/utils/apiClient.ts**
   - API请求封装
   - Token自动添加
   - 错误处理

## 核心实现代码示例

### 1. AuthContext实现

```typescript
// src/contexts/AuthContext.tsx
import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import { User } from '../types';
import * as authService from '../services/authService';

interface AuthContextType {
  user: User | null;
  isAuthenticated: boolean;
  isLoading: boolean;
  login: (phone: string, code: string) => Promise<void>;
  logout: () => void;
  refreshUser: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    // 从localStorage加载token
    const token = localStorage.getItem('auth_token');
    if (token) {
      authService.setToken(token);
      refreshUser();
    } else {
      setIsLoading(false);
    }
  }, []);

  const login = async (phone: string, code: string) => {
    const response = await authService.verifySms(phone, code);
    localStorage.setItem('auth_token', response.token);
    authService.setToken(response.token);
    setUser(response.user);
  };

  const logout = () => {
    localStorage.removeItem('auth_token');
    authService.setToken(null);
    setUser(null);
  };

  const refreshUser = async () => {
    try {
      const userData = await authService.getCurrentUser();
      setUser(userData);
    } catch (error) {
      logout();
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <AuthContext.Provider
      value={{
        user,
        isAuthenticated: !!user,
        isLoading,
        login,
        logout,
        refreshUser,
      }}
    >
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error('useAuth must be used within AuthProvider');
  }
  return context;
}
```

### 2. ThemeToggle权限控制

```typescript
// src/components/ThemeToggle.tsx (修改后)
import { useApp } from '../contexts/AppContext';
import { useAuth } from '../contexts/AuthContext';
import { useState } from 'react';
import PaymentModal from './PaymentModal';

export default function ThemeToggle() {
  const { state, dispatch } = useApp();
  const { user, isAuthenticated } = useAuth();
  const [showPaymentModal, setShowPaymentModal] = useState(false);

  const toggleTheme = () => {
    const newTheme = state.theme === 'light' ? 'dark' : 'light';
    
    // 如果切换到light主题，检查Pro权限
    if (newTheme === 'light') {
      // 未登录或非Pro用户，显示支付弹窗
      if (!isAuthenticated || !user?.isPro) {
        setShowPaymentModal(true);
        return;
      }
    }
    
    dispatch({ type: 'SET_THEME', payload: newTheme });
  };

  return (
    <>
      <button onClick={toggleTheme}>
        {/* 按钮内容 */}
      </button>
      {showPaymentModal && (
        <PaymentModal
          onClose={() => setShowPaymentModal(false)}
          onSuccess={() => {
            setShowPaymentModal(false);
            dispatch({ type: 'SET_THEME', payload: 'light' });
          }}
        />
      )}
    </>
  );
}
```

### 3. PaymentModal实现

```typescript
// src/components/PaymentModal.tsx
import { useState, useEffect } from 'react';
import { useAuth } from '../contexts/AuthContext';
import * as paymentService from '../services/paymentService';

interface PaymentModalProps {
  onClose: () => void;
  onSuccess: () => void;
}

export default function PaymentModal({ onClose, onSuccess }: PaymentModalProps) {
  const { refreshUser } = useAuth();
  const [qrCodeUrl, setQrCodeUrl] = useState<string>('');
  const [orderId, setOrderId] = useState<string>('');
  const [status, setStatus] = useState<'pending' | 'paid' | 'failed'>('pending');

  useEffect(() => {
    // 创建订单
    const createOrder = async () => {
      try {
        const order = await paymentService.createOrder(10.00, 'pro_monthly');
        setQrCodeUrl(order.qrCodeUrl);
        setOrderId(order.orderId);
        
        // 开始轮询订单状态
        startPolling(order.orderId);
      } catch (error) {
        setStatus('failed');
      }
    };
    
    createOrder();
  }, []);

  const startPolling = (orderId: string) => {
    const interval = setInterval(async () => {
      try {
        const order = await paymentService.getOrderStatus(orderId);
        if (order.status === 'paid') {
          clearInterval(interval);
          setStatus('paid');
          await refreshUser();
          setTimeout(() => {
            onSuccess();
          }, 1000);
        }
      } catch (error) {
        // 轮询错误，继续轮询
      }
    }, 2000); // 每2秒轮询一次

    // 30秒后停止轮询
    setTimeout(() => {
      clearInterval(interval);
    }, 30000);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full">
        <h2 className="text-xl font-bold mb-4">升级Pro功能</h2>
        {status === 'pending' && (
          <>
            <p className="mb-4">扫码支付 10元/月</p>
            <img src={qrCodeUrl} alt="支付二维码" className="w-full mb-4" />
            <p className="text-sm text-gray-500">请使用微信扫码支付</p>
          </>
        )}
        {status === 'paid' && (
          <div className="text-center">
            <p className="text-green-600 mb-4">支付成功！</p>
            <p>Pro功能已激活</p>
          </div>
        )}
        <button onClick={onClose} className="mt-4 w-full">关闭</button>
      </div>
    </div>
  );
}
```

---

**相关文档**:
- [05-API接口文档](./05-API接口文档.md)
- [07-后端实现](./07-后端实现.md)
- [返回目录](./00-目录.md)
