# 07-后端实现

## 项目结构

```
backend/
├── src/
│   ├── config/
│   │   ├── database.ts          # 数据库配置
│   │   ├── wechat-pay.ts        # 微信支付配置
│   │   └── sms.ts               # 短信服务配置
│   ├── controllers/
│   │   ├── auth.controller.ts   # 认证控制器
│   │   └── payment.controller.ts # 支付控制器
│   ├── services/
│   │   ├── auth.service.ts      # 认证服务
│   │   ├── payment.service.ts   # 支付服务
│   │   └── sms.service.ts       # 短信服务
│   ├── models/
│   │   ├── user.model.ts        # 用户模型
│   │   └── order.model.ts       # 订单模型
│   ├── middleware/
│   │   ├── auth.middleware.ts   # JWT认证中间件
│   │   └── error.middleware.ts  # 错误处理
│   ├── routes/
│   │   ├── auth.routes.ts       # 认证路由
│   │   └── payment.routes.ts    # 支付路由
│   ├── utils/
│   │   ├── jwt.ts               # JWT工具
│   │   └── validator.ts         # 数据验证
│   └── app.ts                   # Express应用入口
├── docker/
│   ├── Dockerfile               # 后端Dockerfile
│   └── docker-compose.yml      # Docker Compose配置
├── migrations/
│   └── 001_initial.sql         # 数据库迁移脚本
├── .env.example                 # 环境变量示例
├── package.json
└── tsconfig.json
```

## 核心实现代码示例

### 1. JWT认证中间件

```typescript
// src/middleware/auth.middleware.ts
import { Request, Response, NextFunction } from 'express';
import jwt from 'jsonwebtoken';

export interface AuthRequest extends Request {
  userId?: string;
}

export function authMiddleware(
  req: AuthRequest,
  res: Response,
  next: NextFunction
) {
  const token = req.headers.authorization?.replace('Bearer ', '');
  
  if (!token) {
    return res.status(401).json({ success: false, error: '未提供认证令牌' });
  }

  try {
    const decoded = jwt.verify(token, process.env.JWT_SECRET!) as { userId: string };
    req.userId = decoded.userId;
    next();
  } catch (error) {
    return res.status(401).json({ success: false, error: '无效的认证令牌' });
  }
}
```

### 2. 支付服务实现

```typescript
// src/services/payment.service.ts
import { v4 as uuidv4 } from 'uuid';
import { createOrder as createWechatOrder } from '../config/wechat-pay';
import { Order, User } from '../models';

export async function createPaymentOrder(
  userId: string,
  amount: number
): Promise<{ orderId: string; qrCodeUrl: string }> {
  // 创建数据库订单
  const order = await Order.create({
    id: uuidv4(),
    userId,
    amount,
    status: 'pending',
  });

  // 调用微信支付统一下单API
  const wechatOrder = await createWechatOrder({
    out_trade_no: order.id,
    total_fee: Math.round(amount * 100), // 转换为分
    body: 'Pro功能订阅 - 1个月',
    notify_url: process.env.WECHAT_NOTIFY_URL!,
  });

  // 更新订单的微信订单号
  order.wechatOrderId = wechatOrder.out_trade_no;
  order.wechatPrepayId = wechatOrder.prepay_id;
  await order.save();

  return {
    orderId: order.id,
    qrCodeUrl: wechatOrder.code_url, // 二维码URL
  };
}

export async function handleWechatCallback(data: any): Promise<void> {
  // 验证签名
  // ... 签名验证逻辑

  // 更新订单状态
  const order = await Order.findOne({
    where: { wechatOrderId: data.out_trade_no },
  });

  if (!order) {
    throw new Error('订单不存在');
  }

  if (data.result_code === 'SUCCESS') {
    order.status = 'paid';
    order.wechatTransactionId = data.transaction_id;
    order.paidAt = new Date();
    
    // 计算Pro到期时间（当前时间 + 1个月）
    const expiresAt = new Date();
    expiresAt.setMonth(expiresAt.getMonth() + 1);
    order.expiresAt = expiresAt;

    await order.save();

    // 更新用户Pro状态
    const user = await User.findByPk(order.userId);
    if (user) {
      user.isPro = true;
      user.proExpiresAt = expiresAt;
      await user.save();
    }
  }
}
```

---

**相关文档**:
- [04-数据库设计](./04-数据库设计.md)
- [05-API接口文档](./05-API接口文档.md)
- [06-前端实现](./06-前端实现.md)
- [08-部署指南](./08-部署指南.md)
- [返回目录](./00-目录.md)
