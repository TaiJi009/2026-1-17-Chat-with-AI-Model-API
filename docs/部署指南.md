# 部署指南

## 服务器环境准备

### 1. 腾讯云CVM配置

- **配置**: 2核4G内存起步
- **系统**: Ubuntu 20.04 LTS 或 CentOS 7+
- **网络**: 配置安全组，开放80、443、3000端口

### 2. 安装Docker和Docker Compose

```bash
# 安装Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# 安装Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 验证安装
docker --version
docker-compose --version
```

### 3. 安装Nginx

```bash
# Ubuntu
sudo apt update
sudo apt install nginx

# CentOS
sudo yum install nginx
```

## 部署步骤

### 1. 克隆代码

```bash
git clone <your-repo-url>
cd 2026-1-17-Chat-with-AI-Model-API
```

### 2. 配置后端环境变量

```bash
cd backend
cp .env.example .env
# 编辑.env文件，填入所有配置
nano .env
```

### 3. 运行数据库迁移

```bash
cd backend
npm install
npm run migrate
```

### 4. 构建和启动Docker容器

```bash
cd backend/docker
docker-compose up -d
```

### 5. 配置Nginx反向代理

创建Nginx配置文件：

```bash
sudo nano /etc/nginx/sites-available/chat-app-api
```

内容：

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;

    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
```

启用配置：

```bash
sudo ln -s /etc/nginx/sites-available/chat-app-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 6. 配置SSL证书

使用Let's Encrypt免费证书：

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d api.yourdomain.com
```

### 7. 配置前端API地址

在前端项目中，设置环境变量：

```bash
# .env
VITE_API_BASE_URL=https://api.yourdomain.com/api
```

## 监控和维护

### 查看日志

```bash
# Docker容器日志
docker-compose logs -f backend
docker-compose logs -f postgres

# Nginx日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 重启服务

```bash
cd backend/docker
docker-compose restart
```

### 更新代码

```bash
git pull
cd backend
npm install
npm run build
cd docker
docker-compose up -d --build
```

## 安全建议

1. **防火墙**: 只开放必要端口（80, 443）
2. **SSH**: 禁用密码登录，使用密钥认证
3. **定期更新**: 定期更新系统和依赖包
4. **备份**: 定期备份数据库
5. **监控**: 设置监控和告警

## 故障排查

### 服务无法启动

```bash
# 检查容器状态
docker-compose ps

# 查看错误日志
docker-compose logs backend
```

### 数据库连接失败

```bash
# 检查PostgreSQL容器
docker-compose exec postgres psql -U user -d chat_app
```

### Nginx 502错误

检查后端服务是否运行：

```bash
curl http://localhost:3000/health
```
