# 11-安全建议

## 概述

生产环境部署时，安全是首要考虑因素。以下是一些重要的安全建议。

## 1. 使用强密码

### 数据库密码

- 至少12个字符
- 包含大小写字母、数字和特殊字符
- 不要使用常见密码或字典词汇
- 定期更换密码

### JWT密钥

- 至少32个字符（建议64个字符）
- 使用随机生成的字符串
- 不要使用可预测的值
- 定期轮换密钥

### 生成强密码

```bash
# Linux/Mac
openssl rand -base64 32

# PowerShell
-join ((65..90) + (97..122) + (48..57) + (33..47) | Get-Random -Count 16 | ForEach-Object {[char]$_})
```

## 2. 限制端口暴露

### 生产环境配置

**不要**将数据库端口暴露到公网：

```yaml
services:
  postgres:
    # 生产环境移除或注释掉 ports
    # ports:
    #   - "5432:5432"
```

数据库应该只在 Docker 网络内部访问。

### 只暴露必要的端口

```yaml
services:
  backend:
    ports:
      - "3000:3000"  # 只暴露后端API端口
      # 或通过 Nginx 反向代理，只暴露 80/443
```

## 3. 定期更新

### 更新 Docker 镜像

```bash
# 拉取最新镜像
docker-compose pull

# 重新构建并启动
docker-compose up -d --build
```

### 更新依赖

定期检查并更新：
- Node.js 版本
- npm 包依赖
- PostgreSQL 版本
- Docker 和 Docker Compose 版本

### 安全补丁

关注安全公告，及时应用安全补丁。

## 4. 备份数据

### 定期备份

参考 [09-数据备份](./09-数据备份.md) 设置自动备份。

### 备份加密

对敏感数据备份进行加密：

```bash
# 加密备份
docker-compose exec -T postgres pg_dump -U user chat_app | gzip | openssl enc -aes-256-cbc -salt -out backup_$(date +%Y%m%d).enc

# 解密备份
openssl enc -aes-256-cbc -d -in backup_20240120.enc | gunzip | docker-compose exec -T postgres psql -U user chat_app
```

### 备份存储

- 本地备份和远程备份相结合
- 使用云存储服务（加密存储）
- 定期测试备份恢复

## 5. 监控日志

### 日志收集

配置日志收集和分析：
- 集中式日志管理（如 ELK Stack）
- 实时监控异常访问
- 设置告警规则

### 日志分析

定期检查日志，关注：
- 异常登录尝试
- 大量请求（可能的DDoS攻击）
- 错误模式
- 性能异常

### 日志保留

```yaml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"  # 保留更多日志文件用于分析
```

## 6. 环境变量安全

### .env 文件保护

- 不要将 `.env` 文件提交到 Git
- 确保 `.gitignore` 包含 `.env`
- 使用不同的 `.env` 文件用于不同环境

### 敏感信息管理

考虑使用密钥管理服务：
- AWS Secrets Manager
- HashiCorp Vault
- Azure Key Vault

### 环境变量验证

在应用启动时验证必需的环境变量：

```typescript
const requiredEnvVars = ['DB_PASSWORD', 'JWT_SECRET', 'WECHAT_API_KEY'];
requiredEnvVars.forEach(varName => {
  if (!process.env[varName]) {
    throw new Error(`Missing required environment variable: ${varName}`);
  }
});
```

## 7. 网络安全

### 使用 HTTPS

生产环境必须使用 HTTPS：
- 配置 SSL/TLS 证书
- 使用 Let's Encrypt 免费证书
- 配置证书自动续期

### 防火墙配置

```bash
# 只开放必要端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw enable
```

### Docker 网络隔离

使用 Docker 网络隔离容器：

```yaml
networks:
  app-network:
    driver: bridge
    internal: false  # 根据需要设置
```

## 8. 访问控制

### API 认证

- 所有 API 端点使用 JWT 认证
- 实现速率限制（Rate Limiting）
- 使用 HTTPS 传输敏感数据

### 数据库访问

- 使用最小权限原则
- 为不同应用创建不同的数据库用户
- 限制数据库用户权限

## 9. 容器安全

### 非 root 用户运行

Dockerfile 中已配置非 root 用户运行应用。

### 只读文件系统

对于不需要写入的容器，使用只读文件系统：

```yaml
services:
  backend:
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
```

### 资源限制

参考 [10-性能优化](./10-性能优化.md) 配置资源限制，防止资源耗尽攻击。

## 10. 安全审计

### 定期安全审计

- 检查依赖漏洞（使用 `npm audit`）
- 扫描 Docker 镜像漏洞
- 审查访问日志
- 检查配置变更

### 依赖漏洞检查

```bash
# 检查 npm 依赖漏洞
cd backend
npm audit

# 修复漏洞
npm audit fix
```

## 安全检查清单

部署前检查：

- [ ] 所有密码已更改为强密码
- [ ] JWT密钥已设置为随机字符串
- [ ] 数据库端口未暴露到公网
- [ ] HTTPS 已配置
- [ ] 防火墙已正确配置
- [ ] 日志监控已设置
- [ ] 备份策略已实施
- [ ] 环境变量已正确配置
- [ ] 依赖已更新到最新安全版本
- [ ] 安全补丁已应用

## 相关文档

- [07-生产环境部署](./07-生产环境部署.md)
- [08-故障排查](./08-故障排查.md)
- [09-数据备份](./09-数据备份.md)
- [10-性能优化](./10-性能优化.md)

## 下一步

- 查看 [完整部署文档](../付费功能与账号系统.md)
- 查看 [API文档](../../backend/README.md)
- 查看 [Docker详细配置](../../backend/docker/README.md)
