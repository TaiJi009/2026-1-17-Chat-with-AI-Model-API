# 09-数据备份

## 概述

定期备份数据库是生产环境的重要任务，可以防止数据丢失。

## 手动备份

### 备份数据库

```bash
docker-compose exec postgres pg_dump -U user chat_app > backup.sql
```

这会创建一个包含所有数据的 SQL 备份文件。

### 恢复数据库

```bash
docker-compose exec -T postgres psql -U user chat_app < backup.sql
```

**注意**: 恢复操作会覆盖现有数据，请谨慎操作。

## 自动备份脚本

### 创建备份脚本

创建 `backup.sh` 文件：

```bash
#!/bin/bash
BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

docker-compose exec -T postgres pg_dump -U user chat_app > $BACKUP_DIR/backup_$DATE.sql

# 保留最近7天的备份
find $BACKUP_DIR -name "backup_*.sql" -mtime +7 -delete

echo "备份完成: $BACKUP_DIR/backup_$DATE.sql"
```

### 设置执行权限

```bash
chmod +x backup.sh
```

### 运行备份脚本

```bash
./backup.sh
```

## 定时备份（Linux）

### 使用 Crontab

1. **编辑 crontab**:

```bash
crontab -e
```

2. **添加定时任务**:

```bash
# 每天凌晨2点执行备份
0 2 * * * /path/to/backup.sh

# 每小时执行一次备份
0 * * * * /path/to/backup.sh

# 每周一凌晨3点执行备份
0 3 * * 1 /path/to/backup.sh
```

### 使用 Systemd Timer（推荐）

创建 `backup.service`:

```ini
[Unit]
Description=Database Backup Service
After=docker.service

[Service]
Type=oneshot
ExecStart=/path/to/backup.sh
```

创建 `backup.timer`:

```ini
[Unit]
Description=Run database backup daily
Requires=backup.service

[Timer]
OnCalendar=daily
OnCalendar=02:00
Persistent=true

[Install]
WantedBy=timers.target
```

启用定时器:

```bash
sudo systemctl enable backup.timer
sudo systemctl start backup.timer
```

## Windows 定时备份

### 使用任务计划程序

1. 打开"任务计划程序"
2. 创建基本任务
3. 设置触发器（例如：每天凌晨2点）
4. 设置操作：启动程序 `powershell.exe`
5. 添加参数：`-File "C:\path\to\backup.ps1"`

### PowerShell 备份脚本

创建 `backup.ps1`:

```powershell
$BackupDir = ".\backups"
$Date = Get-Date -Format "yyyyMMdd_HHmmss"

New-Item -ItemType Directory -Force -Path $BackupDir

docker-compose exec -T postgres pg_dump -U user chat_app | Out-File "$BackupDir\backup_$Date.sql"

# 删除7天前的备份
Get-ChildItem "$BackupDir\backup_*.sql" | Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-7)} | Remove-Item

Write-Host "备份完成: $BackupDir\backup_$Date.sql"
```

## 备份策略建议

### 备份频率

- **开发环境**: 每天一次
- **生产环境**: 每小时或每6小时一次
- **重要数据**: 每15分钟或实时备份

### 备份保留

- **本地备份**: 保留最近7-30天
- **远程备份**: 保留最近90天或更长
- **归档备份**: 每月或每季度永久保存

### 备份验证

定期测试备份恢复流程，确保备份文件可用：

```bash
# 创建测试数据库
docker-compose exec postgres createdb -U user test_restore

# 恢复备份到测试数据库
docker-compose exec -T postgres psql -U user test_restore < backup.sql

# 验证数据
docker-compose exec postgres psql -U user test_restore -c "SELECT COUNT(*) FROM users;"

# 删除测试数据库
docker-compose exec postgres dropdb -U user test_restore
```

## 远程备份

### 备份到云存储

可以将备份文件上传到云存储服务（如 AWS S3、阿里云 OSS、腾讯云 COS）：

```bash
#!/bin/bash
BACKUP_DIR="./backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="$BACKUP_DIR/backup_$DATE.sql"

# 创建备份
docker-compose exec -T postgres pg_dump -U user chat_app > $BACKUP_FILE

# 压缩备份
gzip $BACKUP_FILE

# 上传到云存储（示例：使用 AWS CLI）
aws s3 cp ${BACKUP_FILE}.gz s3://your-bucket/backups/

# 清理本地备份
rm ${BACKUP_FILE}.gz
```

## 相关文档

- [06-常用命令](./06-常用命令.md)
- [08-故障排查](./08-故障排查.md)
- [11-安全建议](./11-安全建议.md)
