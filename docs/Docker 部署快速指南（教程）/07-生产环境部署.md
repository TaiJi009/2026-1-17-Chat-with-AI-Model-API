# 07-生产环境部署

## 概述

生产环境部署有两种主要方式：使用 Docker 托管平台（推荐）或在自有服务器上部署。

## 方式1: Docker托管平台（推荐）

### Render

1. 访问 [Render](https://render.com)
2. 创建 Web Service
3. 选择 Docker 部署
4. 配置环境变量
5. 部署

**优点:**
- 自动 HTTPS
- 免费层可用
- 支持 Docker Compose
- 自动部署和回滚

### 其他托管平台

- **Fly.io**: 支持 Docker 部署，全球边缘网络
- **Railway**: 简单易用，支持 Docker Compose
- **DigitalOcean App Platform**: 支持 Docker，自动扩展

## 方式2: 本地服务器 + Docker

如果需要在自己的服务器上运行：

### 1. 安装Docker

在 Linux 服务器上安装 Docker：

```bash
curl -fsSL https://get.docker.com | sh
sudo usermod -aG docker $USER
```

### 2. 克隆代码

```bash
git clone <your-repo>
cd backend
```

### 3. 配置环境变量

```bash
cp env.example.txt .env
nano .env
```

填入所有必要的配置，特别是：
- 数据库密码（使用强密码）
- JWT密钥（至少32个字符）
- 微信支付和短信配置
- CORS域名（配置实际的前端域名）

### 4. 启动服务

```bash
cd docker
docker-compose up -d
```

### 5. 配置Nginx（可选，用于自定义域名）

如果需要使用自定义域名和 HTTPS，可以配置 Nginx 作为反向代理：

```nginx
server {
    listen 80;
    server_name api.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl;
    server_name api.yourdomain.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 6. 配置防火墙

确保防火墙允许必要的端口：

```bash
# 允许 HTTP 和 HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 如果直接暴露后端端口（不推荐）
sudo ufw allow 3000/tcp
```

**注意**: 生产环境不建议直接暴露数据库端口（5432）。

## 生产环境注意事项

### 安全配置

1. **使用强密码**: 数据库密码、JWT密钥必须足够复杂
2. **限制端口暴露**: 不要暴露数据库端口到公网
3. **启用HTTPS**: 使用 SSL/TLS 证书
4. **配置防火墙**: 只开放必要的端口
5. **定期更新**: 保持 Docker 镜像和依赖更新

### 监控和日志

1. **配置日志收集**: 使用日志聚合服务（如 Logtail、Papertrail）
2. **设置监控**: 监控服务健康状态和资源使用
3. **配置告警**: 设置异常告警通知

### 备份策略

1. **定期备份数据库**: 参考 [09-数据备份](./09-数据备份.md)
2. **备份配置文件**: 备份 `.env` 文件（安全存储）
3. **测试恢复流程**: 定期测试备份恢复

## 相关文档

- [08-故障排查](./08-故障排查.md)
- [09-数据备份](./09-数据备份.md)
- [10-性能优化](./10-性能优化.md)
- [11-安全建议](./11-安全建议.md)
