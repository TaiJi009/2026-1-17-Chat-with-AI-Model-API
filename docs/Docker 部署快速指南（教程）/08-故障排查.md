# 08-故障排查

## 常见问题及解决方案

### 问题1: 端口被占用

**症状:**
- 启动容器时提示端口已被占用
- 错误信息类似：`Bind for 0.0.0.0:3000 failed: port is already allocated`

**解决方案:**

1. **查找占用端口的进程**:

```bash
# Windows PowerShell
netstat -ano | findstr :3000

# Linux/Mac
lsof -i :3000
```

2. **停止占用端口的进程**，或修改 `docker-compose.yml` 中的端口映射：

```yaml
services:
  backend:
    ports:
      - "3001:3000"  # 改为其他端口
```

3. **重启服务**:

```bash
docker-compose down
docker-compose up -d
```

### 问题2: 数据库连接失败

**症状:**
- 后端日志显示数据库连接错误
- 错误信息类似：`Connection refused` 或 `password authentication failed`

**检查步骤:**

1. **检查数据库容器是否运行**:

```bash
docker-compose ps
```

确保 `chat_app_postgres` 状态为 `Up`。

2. **检查数据库日志**:

```bash
docker-compose logs postgres
```

查看是否有错误信息。

3. **测试数据库连接**:

```bash
docker-compose exec postgres psql -U user -d chat_app
```

如果能成功连接，说明数据库正常。

4. **检查环境变量**:

```bash
# 查看容器环境变量
docker-compose exec backend env | grep DB_

# 确保.env文件在backend目录下
ls -la backend/.env
```

5. **验证数据库配置**:

确保 `.env` 文件中的数据库配置正确：
- `DB_USER` 与 PostgreSQL 用户一致
- `DB_PASSWORD` 与 PostgreSQL 密码一致
- `DB_NAME` 与数据库名称一致

### 问题3: 构建失败

**症状:**
- `docker-compose up` 时构建失败
- 错误信息可能涉及依赖安装或编译错误

**解决方案:**

1. **清理缓存重新构建**:

```bash
docker-compose build --no-cache
docker-compose up -d
```

2. **检查 Dockerfile**:

确保 `backend/docker/Dockerfile` 语法正确。

3. **查看详细错误信息**:

```bash
docker-compose build --progress=plain
```

4. **检查磁盘空间**:

```bash
docker system df
```

如果磁盘空间不足，清理未使用的资源：

```bash
docker system prune -a
```

### 问题4: 环境变量未生效

**症状:**
- 应用使用默认值或空值
- 配置的环境变量没有被读取

**检查:**

1. **查看容器环境变量**:

```bash
docker-compose exec backend env | grep DB_
docker-compose exec backend env | grep JWT_
```

2. **确保.env文件在backend目录下**:

```bash
ls -la backend/.env
```

3. **检查.env文件格式**:

确保 `.env` 文件：
- 没有多余的空格
- 每行格式为 `KEY=value`
- 没有引号（除非值本身需要引号）
- 使用正确的换行符

4. **重启容器**:

```bash
docker-compose restart backend
```

5. **检查docker-compose.yml配置**:

确保 `docker-compose.yml` 中正确引用了 `.env` 文件：

```yaml
services:
  backend:
    volumes:
      - ../.env:/app/.env:ro
```

### 问题5: 容器无法启动

**症状:**
- 容器状态为 `Exited` 或 `Restarting`
- 服务无法访问

**检查步骤:**

1. **查看容器日志**:

```bash
docker-compose logs backend
docker-compose logs postgres
```

2. **检查容器状态**:

```bash
docker-compose ps
docker ps -a
```

3. **检查资源限制**:

如果服务器资源不足，容器可能无法启动：

```bash
docker stats
```

4. **检查健康检查**:

```bash
docker inspect chat_app_backend | grep -A 10 Health
```

### 问题6: 网络连接问题

**症状:**
- 无法拉取 Docker 镜像
- 容器间无法通信

**解决方案:**

1. **配置 Docker 镜像加速器**（中国大陆用户）:

在 Docker Desktop 设置中添加镜像源。

2. **检查网络连接**:

```bash
ping registry-1.docker.io
```

3. **检查防火墙设置**:

确保防火墙允许 Docker 网络通信。

## 获取帮助

如果以上方法都无法解决问题：

1. **收集日志信息**:

```bash
# 保存所有日志到文件
docker-compose logs > docker-logs.txt
```

2. **检查系统信息**:

```bash
docker version
docker-compose version
docker system info
```

3. **查看相关文档**:
   - [06-常用命令](./06-常用命令.md)
   - [10-性能优化](./10-性能优化.md)
   - [11-安全建议](./11-安全建议.md)

## 相关文档

- [06-常用命令](./06-常用命令.md)
- [09-数据备份](./09-数据备份.md)
