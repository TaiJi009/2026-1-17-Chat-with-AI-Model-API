# 10-性能优化

## 概述

通过合理的资源配置和优化，可以提升 Docker 容器的性能和稳定性。

## 1. 资源限制

### 配置资源限制

在 `docker-compose.yml` 中添加资源限制：

```yaml
services:
  backend:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

**说明:**
- `limits`: 最大资源使用量
- `reservations`: 保证的最小资源量
- `cpus`: CPU 核心数（可以是小数，如 '0.5' 表示半个核心）
- `memory`: 内存限制（支持 M、G 等单位）

### 查看资源使用

```bash
# 实时查看资源使用
docker stats

# 查看特定容器
docker stats chat_app_backend chat_app_postgres
```

## 2. 日志管理

### 配置日志轮转

在 `docker-compose.yml` 中配置日志管理：

```yaml
services:
  backend:
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
```

**说明:**
- `max-size`: 单个日志文件最大大小
- `max-file`: 保留的日志文件数量
- 当日志文件达到 `max-size` 时，会自动轮转到新文件
- 最多保留 `max-file` 个日志文件，旧的会被自动删除

### 清理日志

```bash
# 查看日志占用空间
docker system df

# 清理所有未使用的日志
docker system prune -a

# 清理特定容器的日志
docker-compose logs --tail=0 -f backend > /dev/null
```

## 3. 数据库优化

### PostgreSQL 配置优化

在 `docker-compose.yml` 中配置 PostgreSQL 参数：

```yaml
services:
  postgres:
    command:
      - "postgres"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "max_connections=100"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
      - "-c"
      - "random_page_cost=1.1"
      - "-c"
      - "effective_io_concurrency=200"
      - "-c"
      - "work_mem=4MB"
      - "-c"
      - "min_wal_size=1GB"
      - "-c"
      - "max_wal_size=4GB"
```

**参数说明:**
- `shared_buffers`: 共享内存缓冲区大小（建议为系统内存的25%）
- `max_connections`: 最大连接数
- `effective_cache_size`: 有效缓存大小（建议为系统内存的50-75%）
- `work_mem`: 每个查询操作的内存（根据并发查询数调整）

### 数据库索引优化

定期检查并优化数据库索引：

```sql
-- 查看表大小和索引使用情况
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 分析表统计信息
ANALYZE;

-- 查看慢查询
SELECT * FROM pg_stat_statements ORDER BY total_time DESC LIMIT 10;
```

## 4. 网络优化

### 使用自定义网络

Docker Compose 默认会创建网络，可以优化网络配置：

```yaml
networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

### 限制网络带宽

```yaml
services:
  backend:
    networks:
      app-network:
        driver_opts:
          com.docker.network.bridge.enable_icc: "true"
          com.docker.network.bridge.enable_ip_masquerade: "true"
```

## 5. 镜像优化

### 多阶段构建

Dockerfile 已经使用了多阶段构建，可以减少最终镜像大小。

### 清理构建缓存

```bash
# 清理未使用的镜像
docker image prune -a

# 清理构建缓存
docker builder prune
```

## 6. 容器健康检查

### 配置健康检查

在 `docker-compose.yml` 中配置健康检查：

```yaml
services:
  backend:
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
```

**说明:**
- `test`: 健康检查命令
- `interval`: 检查间隔
- `timeout`: 超时时间
- `retries`: 失败重试次数
- `start_period`: 启动宽限期（在此期间失败不计入重试）

## 7. 监控和调优

### 使用监控工具

- **cAdvisor**: 容器资源监控
- **Prometheus**: 指标收集
- **Grafana**: 可视化监控面板

### 性能测试

定期进行性能测试，识别瓶颈：

```bash
# 使用 Apache Bench 测试 API 性能
ab -n 1000 -c 10 http://localhost:3000/health

# 使用 wrk 进行压力测试
wrk -t4 -c100 -d30s http://localhost:3000/health
```

## 相关文档

- [06-常用命令](./06-常用命令.md)
- [07-生产环境部署](./07-生产环境部署.md)
- [08-故障排查](./08-故障排查.md)
